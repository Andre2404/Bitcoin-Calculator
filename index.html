<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kalkulator Bitcoin - Edisi Anak Kost Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        /* Custom scrollbar for slider */
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 20px;
            width: 20px;
            border-radius: 50%;
            background: #F7931A;
            cursor: pointer;
            margin-top: -8px;
            border: 2px solid #fff;
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            cursor: pointer;
            background: #4B5563;
            border-radius: 2px;
        }
        .accordion-content { transition: max-height 0.3s ease-out, padding 0.3s ease; max-height: 0; overflow: hidden; }
        .accordion-content.active { max-height: 500px; }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen p-4 pb-20">

    <div class="max-w-md w-full mx-auto bg-gray-800 rounded-2xl shadow-2xl overflow-hidden border border-gray-700 relative">
        
        <!-- Currency Toggle -->
        <div class="absolute top-4 right-4 bg-gray-900 rounded-lg p-1 border border-gray-600 flex z-20">
            <button onclick="setCurrency('IDR')" id="btnIDR" class="px-3 py-1 text-xs font-bold rounded bg-[#F7931A] text-white transition-all">IDR</button>
            <button onclick="setCurrency('USD')" id="btnUSD" class="px-3 py-1 text-xs font-bold rounded text-gray-400 hover:text-white transition-all">USD</button>
        </div>

        <!-- Header & Price -->
        <div class="bg-gray-700 p-6 text-center relative pt-12 rounded-b-3xl shadow-lg z-10">
            <h1 class="text-xl font-bold text-white mb-1">Simulasi Nabung Bitcoin</h1>
            <p class="text-xs text-gray-400">Spot & Futures Calculator</p>
            <p class="text-xs text-gray-400">web ini dibuat full dengan Gemini Pro dalam hitungan jam</p>
            <div class="mt-4 flex flex-col items-center">
                <span class="text-gray-400 text-xs uppercase tracking-wider">Harga Bitcoin Saat Ini</span>
                <div class="flex items-center gap-2">
                    <span id="livePriceDisplay" class="text-2xl font-bold text-[#F7931A] tracking-tight">Loading...</span>
                    <button onclick="fetchPrice()" class="text-gray-400 hover:text-white animate-pulse" title="Refresh">â†»</button>
                </div>
                <p id="lastUpdated" class="text-[10px] text-gray-500 mt-1">Mengambil data...</p>
            </div>
        </div>

        <div class="p-5 space-y-6">

            <!-- TAB SELECTOR (Spot vs Futures) -->
            <div class="flex bg-gray-900 rounded-lg p-1 border border-gray-600">
                <button onclick="switchMode('spot')" id="tabSpot" class="flex-1 py-2 text-sm font-bold rounded-md bg-blue-600 text-white shadow transition-all">
                    Spot (Aman)
                </button>
                <button onclick="switchMode('futures')" id="tabFutures" class="flex-1 py-2 text-sm font-bold rounded-md text-gray-400 hover:text-white transition-all">
                    Futures (Bahaya)
                </button>
            </div>

            <!-- EXCHANGE SELECTOR (Fees) -->
            <div>
                <label class="block text-xs font-medium text-gray-400 mb-1">Pilih Exchange (Simulasi Admin Fee)</label>
                <select id="exchangeSelect" onchange="calculateResult()" class="w-full bg-gray-900 border border-gray-600 text-white text-sm rounded-lg focus:ring-[#F7931A] focus:border-[#F7931A] block p-2.5">
                    <option value="0|0">Tanpa Fee (Murni Matematika)</option>
                    <option value="0.1|0">Tokocrypto (Fee 0.1%)</option>
                    <option value="0.3|0">Indodax (Fee 0.3%)</option>
                    <option value="0.11|0">Pintu (Spread ~0.11% + Hidden)</option>
                    <option value="0.1|0">Ajaib Kripto (Fee 0.1%)</option>
                    <option value="0.2|5000">Reku (Fee 0.2% + Depo 5rb)</option>
                    <option value="0.06|0">Binance/Bybit (Futures Low Fee)</option>
                </select>
                <p id="feeInfo" class="text-[10px] text-gray-500 mt-1 text-right">Fee trading dihitung saat Beli & Jual.</p>
            </div>

            <!-- INPUT MODAL -->
            <div>
                <label class="block text-sm font-medium text-gray-300 mb-2">Modal Awal (<span class="currency-code">IDR</span>)</label>
                <div class="relative rounded-md shadow-sm">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <span class="currency-symbol text-gray-400 sm:text-sm">Rp</span>
                    </div>
                    <input type="text" id="investmentInput" class="focus:ring-[#F7931A] focus:border-[#F7931A] block w-full pl-10 pr-4 sm:text-sm border-gray-600 rounded-lg bg-gray-900 text-white py-3 placeholder-gray-500 font-mono text-lg" value="200.000">
                </div>
            </div>

            <!-- FUTURES CONTROLS (Hidden by default) -->
            <div id="futuresSection" class="hidden space-y-4 bg-gray-900/50 p-4 rounded-xl border border-red-900/50">
                <div class="flex justify-between items-center">
                    <label class="text-sm font-bold text-red-400">âš¡ Leverage (Pengali)</label>
                    <span id="leverageDisplay" class="text-xs font-mono bg-red-900 text-red-200 px-2 py-1 rounded">10x</span>
                </div>
                <input type="range" min="1" max="125" value="10" id="leverageSlider" class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer accent-red-500">
                
                <div class="flex gap-2">
                    <button onclick="setPosition('long')" id="btnLong" class="flex-1 py-2 text-xs font-bold rounded bg-green-700 text-white border border-green-500">LONG (Naik)</button>
                    <button onclick="setPosition('short')" id="btnShort" class="flex-1 py-2 text-xs font-bold rounded bg-gray-700 text-gray-400 border border-gray-600">SHORT (Turun)</button>
                </div>
                <p class="text-[10px] text-gray-400 italic">*Semakin besar leverage, semakin cepat uang habis jika salah tebak.</p>
            </div>

            <hr class="border-gray-700 border-dashed">

            <!-- SIMULASI HARGA -->
            <div class="bg-gray-900/50 p-4 rounded-xl border border-gray-700">
                <label class="block text-sm font-medium text-gray-300 mb-3 text-center">Jika Harga Bitcoin Jadi...</label>
                
                <div class="relative rounded-md shadow-sm mb-4">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <span class="currency-symbol text-gray-400 sm:text-sm">Rp</span>
                    </div>
                    <input type="text" id="simulatedPriceInput" class="focus:ring-blue-500 focus:border-blue-500 block w-full pl-10 sm:text-sm border-gray-600 rounded-lg bg-gray-800 text-white py-2 text-center font-bold font-mono">
                </div>

                <div class="relative pt-1">
                    <input type="range" min="-50" max="50" value="0" class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer" id="percentageSlider">
                    <div class="flex justify-between text-[10px] text-gray-500 mt-1">
                        <span>-50%</span>
                        <span id="sliderPercentageText" class="text-blue-400 font-bold">0%</span>
                        <span>+50%</span>
                    </div>
                </div>
            </div>

            <!-- HASIL KARTU -->
            <div class="text-center">
                <p class="text-sm text-gray-400 mb-1">Total Aset Bersih:</p>
                <div id="resultCard" class="bg-gray-700 p-4 rounded-xl border-l-4 border-gray-500 transition-all duration-300 relative overflow-hidden">
                    <div id="liquidatedOverlay" class="hidden absolute inset-0 bg-red-900/90 flex flex-col items-center justify-center z-10">
                        <span class="text-2xl">ðŸ’€</span>
                        <span class="font-bold text-white uppercase tracking-widest">Liquidated</span>
                        <span class="text-xs text-red-200">Uang Habis Bosku</span>
                    </div>

                    <h2 id="finalValueDisplay" class="text-3xl font-bold text-white relative z-0">Rp 200.000</h2>
                    
                    <div class="flex justify-center items-center gap-2 mt-2 relative z-0">
                        <span id="pnlLabel" class="text-xs font-bold bg-gray-600 px-2 py-0.5 rounded text-gray-300">Impas</span>
                        <span id="pnlAmount" class="text-xs text-gray-300">(0)</span>
                    </div>
                    
                    <div class="mt-3 pt-2 border-t border-gray-600/50 flex justify-between text-[10px] text-gray-400 relative z-0">
                        <span>Potongan Admin: <span id="feeDisplay" class="text-red-300">Rp 0</span></span>
                        <span>Estimasi</span>
                    </div>
                </div>
                
                <div class="mt-4 p-3 bg-blue-900/20 border border-blue-800/50 rounded-lg text-left">
                    <p class="text-xs text-blue-300 font-bold mb-1">ðŸ’¡ Perspektif:</p>
                    <p id="funFact" class="text-xs text-blue-100 leading-relaxed">Masih aman, uang utuh.</p>
                </div>
            </div>

        </div>

        <!-- EDUCATIONAL SECTION -->
        <div class="bg-gray-800 border-t border-gray-700 p-6 pb-10">
            <h3 class="text-lg font-bold text-white mb-4 flex items-center gap-2">
                School of Crypto
                <span class="text-[10px] bg-[#F7931A] text-black px-2 py-0.5 rounded-full">Pemula Wajib Baca</span>
            </h3>
            
            <div class="space-y-2">
                <!-- Item 1 -->
                <div class="border border-gray-700 rounded-lg overflow-hidden">
                    <button onclick="toggleAccordion('acc1')" class="w-full text-left px-4 py-3 bg-gray-700 hover:bg-gray-600 text-sm font-semibold text-gray-200 flex justify-between items-center">
                        Kenapa Investasi Bitcoin?
                        <span class="text-gray-400 text-xs">â–¼</span>
                    </button>
                    <div id="acc1" class="accordion-content bg-gray-800">
                        <div class="p-4 text-xs text-gray-300 leading-relaxed">
                            Bitcoin itu aset digital yang jumlahnya terbatas (cuma 21 juta keping di dunia). Beda sama uang kertas yang bisa dicetak terus (inflasi), Bitcoin didesain anti-inflasi. Orang beli Bitcoin buat "menabung" kekayaan jangka panjang agar tidak tergerus inflasi, mirip seperti beli Emas tapi versi digital dan lebih mudah dibawa.
                        </div>
                    </div>
                </div>

                <!-- Item 2 -->
                <div class="border border-gray-700 rounded-lg overflow-hidden">
                    <button onclick="toggleAccordion('acc2')" class="w-full text-left px-4 py-3 bg-gray-700 hover:bg-gray-600 text-sm font-semibold text-gray-200 flex justify-between items-center">
                        Spot vs Futures (Bedanya Apa?)
                        <span class="text-gray-400 text-xs">â–¼</span>
                    </button>
                    <div id="acc2" class="accordion-content bg-gray-800">
                        <div class="p-4 text-xs text-gray-300 leading-relaxed space-y-2">
                            <p><strong class="text-green-400">SPOT:</strong> Kamu beli barangnya beneran. Kalau harga turun, kamu cuma rugi nilai (floating loss), tapi barangnya masih ada. Uang gak bakal hilang kecuali harga jadi Rp 0. <span class="italic">Cocok buat pemula/nabung.</span></p>
                            <p><strong class="text-red-400">FUTURES:</strong> Kamu cuma tebak harga (judi kontrak). Pakai Leverage (uang pinjaman). Kalau salah tebak dikit aja, uangmu bisa dilikuidasi (HILANG TOTAL) oleh exchange. <span class="italic">Sangat berisiko, hindari kalau belum pro.</span></p>
                        </div>
                    </div>
                </div>

                <!-- Item 3 -->
                <div class="border border-gray-700 rounded-lg overflow-hidden">
                    <button onclick="toggleAccordion('acc3')" class="w-full text-left px-4 py-3 bg-gray-700 hover:bg-gray-600 text-sm font-semibold text-gray-200 flex justify-between items-center">
                        Risk Management (Biar Gak Rungkad)
                        <span class="text-gray-400 text-xs">â–¼</span>
                    </button>
                    <div id="acc3" class="accordion-content bg-gray-800">
                        <div class="p-4 text-xs text-gray-300 leading-relaxed">
                            1. <strong>Uang Dingin:</strong> Jangan pakai uang makan/SPP.<br>
                            2. <strong>Diversifikasi:</strong> Jangan taruh semua telur di satu keranjang.<br>
                            3. <strong>Stop Loss (Futures):</strong> Pasang batas rugi otomatis.<br>
                            4. <strong>Jangan FOMO:</strong> Jangan beli pas harga lagi hijau tebal (pucuk), biasanya bakal koreksi.
                        </div>
                    </div>
                </div>

                <!-- Item 4 -->
                <div class="border border-gray-700 rounded-lg overflow-hidden">
                    <button onclick="toggleAccordion('acc4')" class="w-full text-left px-4 py-3 bg-gray-700 hover:bg-gray-600 text-sm font-semibold text-gray-200 flex justify-between items-center">
                        Halving & DCA (Strategi Jitu)
                        <span class="text-gray-400 text-xs">â–¼</span>
                    </button>
                    <div id="acc4" class="accordion-content bg-gray-800">
                        <div class="p-4 text-xs text-gray-300 leading-relaxed">
                            <p class="mb-2"><strong>Halving:</strong> Setiap 4 tahun, stok Bitcoin baru dipotong setengah. Biasanya harga naik drastis setahun setelah halving karena barang makin langka.</p>
                            <p><strong>DCA (Dollar Cost Averaging):</strong> Strategi nyicil rutin (misal 100rb/minggu) tanpa peduli harga. Ini strategi terbaik buat ngalahin volatilitas pasar.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script>
        // --- State Variables ---
        let currency = 'IDR';
        let mode = 'spot'; // 'spot' or 'futures'
        let position = 'long'; // 'long' or 'short'
        let leverage = 10;
        let prices = { IDR: 0, USD: 0 };
        let feePercent = 0; // percentage
        let feeFlat = 0; // flat fee (deposit etc)

        // --- Elements ---
        const els = {
            livePrice: document.getElementById('livePriceDisplay'),
            lastUpdated: document.getElementById('lastUpdated'),
            investInput: document.getElementById('investmentInput'),
            simPriceInput: document.getElementById('simulatedPriceInput'),
            slider: document.getElementById('percentageSlider'),
            sliderText: document.getElementById('sliderPercentageText'),
            finalDisplay: document.getElementById('finalValueDisplay'),
            resultCard: document.getElementById('resultCard'),
            pnlLabel: document.getElementById('pnlLabel'),
            pnlAmount: document.getElementById('pnlAmount'),
            funFact: document.getElementById('funFact'),
            btnIDR: document.getElementById('btnIDR'),
            btnUSD: document.getElementById('btnUSD'),
            currencySymbols: document.querySelectorAll('.currency-symbol'),
            currencyCodes: document.querySelectorAll('.currency-code'),
            
            // New Elements
            tabSpot: document.getElementById('tabSpot'),
            tabFutures: document.getElementById('tabFutures'),
            futuresSection: document.getElementById('futuresSection'),
            leverageSlider: document.getElementById('leverageSlider'),
            leverageDisplay: document.getElementById('leverageDisplay'),
            btnLong: document.getElementById('btnLong'),
            btnShort: document.getElementById('btnShort'),
            exchangeSelect: document.getElementById('exchangeSelect'),
            feeDisplay: document.getElementById('feeDisplay'),
            liquidatedOverlay: document.getElementById('liquidatedOverlay')
        };

        // --- Formatting ---
        const formatNumber = (num) => {
            if (currency === 'IDR') return new Intl.NumberFormat('id-ID', { maximumFractionDigits: 0 }).format(num);
            return new Intl.NumberFormat('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(num);
        };

        const formatCurrency = (num) => {
            if (currency === 'IDR') return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', maximumFractionDigits: 0 }).format(num);
            return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', minimumFractionDigits: 2 }).format(num);
        };

        // --- Core Logic ---

        async function fetchPrice() {
            els.livePrice.innerText = "Loading...";
            try {
                const response = await fetch('https://api.coingecko.com/api/v3/simple/price?ids=bitcoin&vs_currencies=idr,usd');
                const data = await response.json();
                
                if(data.bitcoin) {
                    prices.IDR = data.bitcoin.idr;
                    prices.USD = data.bitcoin.usd;
                    updateUIWithNewPrice();
                    const now = new Date();
                    els.lastUpdated.innerText = `Update: ${now.toLocaleTimeString()}`;
                }
            } catch (error) {
                console.error(error);
                els.livePrice.innerText = "Error";
                if(prices.IDR === 0) { // Fallback
                    prices.IDR = 1550000000;
                    prices.USD = 96000;
                    updateUIWithNewPrice();
                }
            }
        }

        function updateUIWithNewPrice() {
            const currentPrice = prices[currency];
            els.livePrice.innerText = formatNumber(currentPrice);
            els.simPriceInput.value = formatNumber(currentPrice);
            els.slider.value = 0;
            els.sliderText.innerText = "0%";
            calculateResult();
        }

        function calculateResult() {
            // Get Inputs
            let rawInvest = els.investInput.value.replace(/[^0-9.]/g, '');
            if(currency === 'IDR') rawInvest = els.investInput.value.replace(/[^0-9]/g, '');
            const initialInvestment = parseFloat(rawInvest) || 0;

            let rawSim = els.simPriceInput.value.replace(/[^0-9.]/g, '');
            if(currency === 'IDR') rawSim = els.simPriceInput.value.replace(/[^0-9]/g, '');
            const simulatedPrice = parseFloat(rawSim) || 0;

            const currentPrice = prices[currency];
            if(currentPrice === 0) return;

            // Get Fees
            const feeVal = els.exchangeSelect.value.split('|');
            feePercent = parseFloat(feeVal[0]);
            feeFlat = parseFloat(feeVal[1]);
            
            // Adjust Flat Fee Currency
            let adjustedFeeFlat = feeFlat;
            if(currency === 'USD') adjustedFeeFlat = feeFlat / 16000;

            // --- LOGIC PERHITUNGAN ---
            
            let finalValue = 0;
            let totalFee = 0;
            let pnl = 0;
            let isLiquidated = false;

            if (mode === 'spot') {
                // SPOT CALCULATION
                // 1. Potong Fee Depo & Beli
                const entryFee = (initialInvestment * (feePercent / 100));
                const netInvest = initialInvestment - adjustedFeeFlat - entryFee;
                
                const btcAmount = netInvest / currentPrice;
                
                // 2. Hitung Nilai Akhir sebelum fee jual
                let grossValue = btcAmount * simulatedPrice;
                
                // 3. Potong Fee Jual
                const exitFee = grossValue * (feePercent / 100);
                finalValue = grossValue - exitFee;
                
                totalFee = adjustedFeeFlat + entryFee + exitFee;
                pnl = finalValue - initialInvestment;

            } else {
                // FUTURES CALCULATION
                // Simplified PnL = (PriceDiff / Entry) * PositionSize * Direction
                // Position Size = Margin * Leverage
                
                const margin = initialInvestment; // Asumsi semua modal dipakai margin
                const positionSize = margin * leverage;
                
                // Fee Futures (Opening + Closing) on Notion Value usually
                // Kita sederhanakan: fee dikenakan pada total posisi x 2 (buka tutup)
                const futuresFee = positionSize * (feePercent / 100) * 2; 
                totalFee = futuresFee;

                const priceChangePercent = (simulatedPrice - currentPrice) / currentPrice;
                
                let grossPnL = 0;
                if (position === 'long') {
                    grossPnL = priceChangePercent * positionSize;
                } else {
                    grossPnL = -priceChangePercent * positionSize; // Short: profit if price drops
                }

                // Final Equity = Margin + GrossPnL - Fees
                finalValue = margin + grossPnL - totalFee;
                pnl = finalValue - initialInvestment;

                // Check Liquidation (Simplified: if Equity <= 0)
                if (finalValue <= 0) {
                    finalValue = 0;
                    pnl = -initialInvestment;
                    isLiquidated = true;
                }
            }

            // Update UI Numbers
            els.finalDisplay.innerText = formatCurrency(finalValue);
            els.pnlAmount.innerText = `(${pnl >= 0 ? '+' : ''}${formatCurrency(pnl)})`;
            els.feeDisplay.innerText = formatCurrency(totalFee);

            // Update UI Styles
            els.liquidatedOverlay.classList.toggle('hidden', !isLiquidated);
            
            const percentChange = (pnl / initialInvestment) * 100;
            
            if (pnl > 0) {
                els.resultCard.className = "bg-gray-700 p-4 rounded-xl border-l-4 border-green-500 bg-green-900/20 transition-all overflow-hidden relative";
                els.pnlLabel.className = "text-xs font-bold bg-green-600 text-white px-2 py-0.5 rounded";
                els.pnlLabel.innerText = `Cuan ${percentChange.toFixed(2)}%`;
            } else if (pnl < 0) {
                els.resultCard.className = "bg-gray-700 p-4 rounded-xl border-l-4 border-red-500 bg-red-900/20 transition-all overflow-hidden relative";
                els.pnlLabel.className = "text-xs font-bold bg-red-600 text-white px-2 py-0.5 rounded";
                els.pnlLabel.innerText = `Rugi ${Math.abs(percentChange).toFixed(2)}%`;
            } else {
                els.resultCard.className = "bg-gray-700 p-4 rounded-xl border-l-4 border-gray-500 overflow-hidden relative";
                els.pnlLabel.className = "text-xs font-bold bg-gray-600 text-gray-300 px-2 py-0.5 rounded";
                els.pnlLabel.innerText = "Impas";
            }

            generateFunFact(pnl, isLiquidated);
        }

        function generateFunFact(pnl, isLiq) {
            if(isLiq) {
                els.funFact.innerText = "HARTA HABIS! Inilah kenapa Futures bahaya buat pemula. Leverage adalah pedang bermata dua.";
                return;
            }

            // Convert to IDR for text logic
            let valIDR = pnl;
            if(currency === 'USD') valIDR = pnl * 16000;
            const absVal = Math.abs(valIDR);

            if (pnl > 0) {
                if(mode === 'futures') els.funFact.innerText = "Gacor Kang! Tapi hati-hati, jangan maruk, market bisa berbalik kapan aja.";
                else if(absVal < 50000) els.funFact.innerText = "Lumayan buat nambah uang kopi.";
                else if (absVal < 1000000) els.funFact.innerText = "Widih! Bisa makan enak atau bayar tagihan internet.";
                else els.funFact.innerText = "Sultan! Jangan lupa sedekah biar makin berkah.";
            } else if (pnl < 0) {
                if(mode === 'futures') els.funFact.innerText = "Tuh kan... Futures itu kejam. Floating loss digabung leverage bikin senam jantung.";
                else if(absVal < 50000) els.funFact.innerText = "Tenang, cuma seharga paket data.";
                else if (absVal < 500000) els.funFact.innerText = "Puasa senin kamis dulu ya kak...";
                else els.funFact.innerText = "Innalillahi... Anggap uang kuliah kehidupan. Hold terus kalau Spot!";
            } else {
                els.funFact.innerText = "Uang aman, hati tenang.";
            }
        }

        // --- Interaction Handlers ---

        function switchMode(newMode) {
            mode = newMode;
            if(mode === 'spot') {
                els.tabSpot.className = "flex-1 py-2 text-sm font-bold rounded-md bg-blue-600 text-white shadow transition-all";
                els.tabFutures.className = "flex-1 py-2 text-sm font-bold rounded-md text-gray-400 hover:text-white transition-all";
                els.futuresSection.classList.add('hidden');
                // Auto reset exchange selection to something sensible for spot
                els.exchangeSelect.value = "0|0"; 
            } else {
                els.tabSpot.className = "flex-1 py-2 text-sm font-bold rounded-md text-gray-400 hover:text-white transition-all";
                els.tabFutures.className = "flex-1 py-2 text-sm font-bold rounded-md bg-red-600 text-white shadow transition-all";
                els.futuresSection.classList.remove('hidden');
                // Suggest Binance/Bybit for futures fee logic
                els.exchangeSelect.value = "0.06|0";
                alert("âš ï¸ PERINGATAN: Futures sangat berisiko tinggi. Uang bisa habis 100% (Liquidated).");
            }
            calculateResult();
        }

        function setPosition(pos) {
            position = pos;
            if(pos === 'long') {
                els.btnLong.className = "flex-1 py-2 text-xs font-bold rounded bg-green-700 text-white border border-green-500";
                els.btnShort.className = "flex-1 py-2 text-xs font-bold rounded bg-gray-700 text-gray-400 border border-gray-600";
            } else {
                els.btnLong.className = "flex-1 py-2 text-xs font-bold rounded bg-gray-700 text-gray-400 border border-gray-600";
                els.btnShort.className = "flex-1 py-2 text-xs font-bold rounded bg-red-700 text-white border border-red-500";
            }
            calculateResult();
        }

        function setCurrency(curr) {
            if(currency === curr) return;
            // Conversion logic simple approximation for UX
            let rawInvest = els.investInput.value.replace(/[^0-9.]/g, '');
            if(currency === 'IDR') rawInvest = els.investInput.value.replace(/[^0-9]/g, '');
            let val = parseFloat(rawInvest) || 0;

            if(curr === 'USD') val = (prices.IDR && prices.USD) ? val * (prices.USD / prices.IDR) : val / 16000;
            else val = (prices.IDR && prices.USD) ? val * (prices.IDR / prices.USD) : val * 16000;

            currency = curr;
            
            // Toggle Button Styles
            if(curr === 'IDR') {
                els.btnIDR.className = "px-3 py-1 text-xs font-bold rounded bg-[#F7931A] text-white";
                els.btnUSD.className = "px-3 py-1 text-xs font-bold rounded text-gray-400 hover:text-white";
                els.investInput.value = formatNumber(Math.floor(val));
                document.querySelectorAll('.currency-symbol').forEach(e => e.innerText = 'Rp');
                document.querySelectorAll('.currency-code').forEach(e => e.innerText = 'IDR');
            } else {
                els.btnUSD.className = "px-3 py-1 text-xs font-bold rounded bg-[#F7931A] text-white";
                els.btnIDR.className = "px-3 py-1 text-xs font-bold rounded text-gray-400 hover:text-white";
                els.investInput.value = formatNumber(val);
                document.querySelectorAll('.currency-symbol').forEach(e => e.innerText = '$');
                document.querySelectorAll('.currency-code').forEach(e => e.innerText = 'USD');
            }
            updateUIWithNewPrice();
        }

        function toggleAccordion(id) {
            const el = document.getElementById(id);
            const isActive = el.classList.contains('active');
            // Close all
            document.querySelectorAll('.accordion-content').forEach(ac => ac.classList.remove('active'));
            // Open clicked if not already open
            if(!isActive) el.classList.add('active');
        }

        // --- Event Listeners ---
        els.investInput.addEventListener('input', (e) => {
            let val = e.target.value;
            if(currency === 'IDR') {
                val = val.replace(/[^0-9]/g, '');
                if(val) e.target.value = parseInt(val).toLocaleString('id-ID');
            } else {
                e.target.value = val.replace(/[^0-9.]/g, '');
            }
            calculateResult();
        });

        els.simPriceInput.addEventListener('input', (e) => {
            let val = e.target.value.replace(/[^0-9.]/g, '');
            if(currency === 'IDR') {
                val = e.target.value.replace(/[^0-9]/g, '');
                if(val) e.target.value = parseInt(val).toLocaleString('id-ID');
            }
            
            // Update slider visual
            const numVal = parseFloat(val.replace(/\./g, '')) || 0;
            const current = prices[currency];
            if(current > 0) {
                const percent = ((numVal - current) / current) * 100;
                // Don't move slider handle if out of bounds to avoid confusion, just update calc
                els.sliderText.innerText = (percent > 0 ? '+' : '') + percent.toFixed(0) + '%';
            }
            calculateResult();
        });

        els.slider.addEventListener('input', (e) => {
            const percent = parseInt(e.target.value);
            els.sliderText.innerText = (percent > 0 ? '+' : '') + percent + '%';
            const current = prices[currency];
            const newVal = current * (1 + (percent / 100));
            els.simPriceInput.value = formatNumber(newVal);
            calculateResult();
        });

        els.leverageSlider.addEventListener('input', (e) => {
            leverage = parseInt(e.target.value);
            els.leverageDisplay.innerText = leverage + 'x';
            calculateResult();
        });

        // Init
        fetchPrice();
        // Expose global functions
        window.setCurrency = setCurrency;
        window.fetchPrice = fetchPrice;
        window.switchMode = switchMode;
        window.setPosition = setPosition;
        window.toggleAccordion = toggleAccordion;
        window.calculateResult = calculateResult;

    </script>
</body>
</html>